# 📦 Serbot BlackBox Database Schema

이 문서는 **Serbot 로봇 시스템의 블랙박스(DB) 구조**를 설명한다.  
본 DB는 **영상(Video) · 센서(Sensor) · 비전(Vision)** 데이터를  
**시간(timestamp) 기준으로 저장·재생·분석**하기 위해 설계되었다.

---

## 🧠 설계 철학

- **데이터 주기 분리**
  - 영상(FPS), 센서(주기), 비전 이벤트(비정기)는 주기가 다르다
  - 하나의 테이블로 묶지 않고 **역할 단위로 분리**
- **시간 기준 느슨한 결합**
  - FK 남용 ❌
  - `received_at_ms` 기준 JOIN ⭕
- **블랙박스 재생 가능**
  - “이 시점에 로봇이 무엇을 봤고, 센서는 어땠는가” 재현 가능

---

## 🗂️ 테이블 목록

```text
serbot
 ├─ video_session
 ├─ video_frame
 └─ sensor_snapshot
```
## 1️⃣ video_session — 영상 세션 메타데이터

역할
	•	하나의 영상 녹화 세션을 대표
	•	카메라 연결 시 시작, 끊기면 종료
### 📋 컬럼 설명

| 컬럼명 | 설명 | 필수 여부 | 제약 및 규칙 |
|------|------|---------|-------------|
| **id** | 영상 세션의 고유 식별자 | 필수 | • NULL 불가<br>• 자동 증가<br>• Primary Key |
| **started_at_ms** | 영상 세션 시작 시각 (서버 기준, ms) | 필수 | • NULL 불가<br>• 세션 시작 시 반드시 기록 |
| **ended_at_ms** | 영상 세션 종료 시각 (서버 기준, ms) | 선택 | • NULL 가능<br>• NULL이면 현재 녹화 중 상태 |
| **fps** | DB에 저장되는 영상 프레임 속도 | 필수 | • 기본값 5<br>• 초당 저장 프레임 수 |
| **width** | 영상 가로 해상도(px) | 선택 | • NULL 가능<br>• 필요 시만 저장 |
| **height** | 영상 세로 해상도(px) | 선택 | • NULL 가능<br>• 필요 시만 저장 |
| **codec** | 영상 인코딩 방식 | 필수 | • 기본값 `JPEG`<br>• 향후 H.264 등 확장 가능 |
| **note** | 세션에 대한 설명 또는 출처 정보 | 선택 | • NULL 가능<br>• 예: `robot:6003` |

---

### 🧠 설계 의도

- **영상 데이터를 직접 이 테이블에 저장하지 않는다**
  - 실제 프레임 데이터는 `video_frame` 테이블에 저장
  - `video_session`은 메타데이터 관리 전용

- **시간 기반 조회를 쉽게 하기 위함**
  - 특정 시점의 영상, 센서, 비전 이벤트를 연결 가능

- **녹화 중 / 종료 상태를 명확히 구분**
  - `ended_at_ms = NULL` → 현재 녹화 중인 세션

---


<br/>


## 2️⃣ video_frame — 영상 프레임 데이터

역할
	•	실제 영상 프레임(JPEG 바이트) 저장
	•	반드시 하나의 video_session에 속함

테이블 구조
### 📋 컬럼 설명

| 컬럼명 | 설명 | 필수 여부 | 제약 및 규칙 |
|------|------|---------|-------------|
| **id** | 영상 프레임의 고유 식별자 | 필수 | • NULL 불가<br>• 자동 증가<br>• Primary Key |
| **session_id** | 이 프레임이 속한 영상 세션 ID | 필수 | • NULL 불가<br>• `video_session.id` 참조<br>• 세션 삭제 시 자동 삭제 |
| **received_at_ms** | 서버가 이 프레임을 수신한 시각 (ms) | 필수 | • NULL 불가<br>• 서버 기준 시각 |
| **frame_index** | 세션 내 프레임 순번 | 필수 | • NULL 불가<br>• 0부터 증가 |
| **mime** | 프레임 이미지 포맷 | 필수 | • 기본값 `image/jpeg`<br>• 추후 PNG 등 확장 가능 |
| **jpeg_bytes** | 실제 이미지 데이터 (바이트) | 필수 | • NULL 불가<br>• JPEG 원본 데이터 |
| **bytes_len** | 이미지 바이트 크기 | 필수 | • NULL 불가<br>• 성능/검증용 메타데이터 |
주요 컬럼
	•	session_id : 소속 영상 세션
	•	received_at_ms : 프레임 수신 시각
	•	frame_index : 세션 내 프레임 번호
	•	jpeg_bytes : 실제 이미지 데이터
### 🧠 설계 의도

- **영상 파일을 통째로 저장하지 않는다**
  - 프레임 단위로 쪼개 저장 → 탐색/재생/동기화 용이

- **시간 기반 동기화**
  - `received_at_ms` 기준으로:
    - 센서 데이터
    - 비전 이벤트
    - 영상 프레임
    → 모두 같은 타임라인에서 재생 가능

- **DB 기반 블랙박스 구현**
  - 특정 시점 → 해당 프레임 바로 조회 가능

<br/>





----
## 3️⃣ sensor_snapshot — 센서 상태 스냅샷

역할
	•	로봇의 환경 상태를 주기적으로 저장
	•	영상/비전과 시간 기준으로 대응

테이블 구조
### 📋 컬럼 설명

| 컬럼명 | 설명 | 필수 여부 | 제약 및 규칙 |
|------|------|---------|-------------|
| **id** | 센서 스냅샷의 고유 식별자 | 필수 | • NULL 불가<br>• 자동 증가<br>• Primary Key |
| **received_at_ms** | 서버가 센서 데이터를 수신한 시각 (ms) | 필수 | • NULL 불가<br>• 서버 기준 시각 |
| **fire** | 화재 감지 여부 | 필수 | • NULL 불가<br>• 0 = 정상<br>• 1 = 화재 감지 |
| **co2** | 이산화탄소 농도 값 | 필수 | • NULL 불가<br>• 단위: ppm |
| **pm25** | 미세먼지(PM2.5) 농도 | 필수 | • NULL 불가<br>• 단위: μg/m³ |
| **pm10** | 미세먼지(PM10) 농도 | 필수 | • NULL 불가<br>• 단위: μg/m³ |
| **pir** | 사람 감지 여부 (호환용) | 선택 | • NULL 허용<br>• 현재는 비전 감지 결과를 저장 |
| **source** | 데이터 출처 | 필수 | • 기본값 `REAL`<br>• 예: `ROBOT`, `DEMO`, `CACHE` |

### 🧠 설계 의도

- **타임라인 중심 구조**
  - 모든 센서 데이터는 `received_at_ms` 기준으로 정렬
  - 영상 프레임, 비전 이벤트와 시간 동기화 가능

- **“현재 상태”가 아닌 “기록”**
  - 최신 값만 유지하지 않음
  - 과거 상태를 그대로 보존 → 재생/분석 가능

- **서버 기준 시간 통일**
  - 로봇 시간 오차 제거
  - 모든 데이터는 서버 수신 시각 기준

<br/>





----

주요 컬럼
	•	received_at_ms : 센서 스냅샷 시각
	•	fire : 화재 여부
	•	co2, pm25, pm10 : 환경 센서 값
	•	pir : 사람 감지 (시연/호환용)
	•	source : REAL / ROBOT / DEMO

📌 영상 프레임과 FK로 묶지 않음
	•	센서 주기 ≠ FPS
	•	시간 차이로 JOIN


✅ 요약
	•	video_session : 영상 세션 단위
	•	video_frame : 실제 영상 데이터
	•	sensor_snapshot : 환경 상태 기록
	•	모든 데이터는 시간(timestamp)으로 연결